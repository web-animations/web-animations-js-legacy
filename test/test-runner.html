<!--
Copyright 2012 Google Inc. All Rights Reserved.

vim: set ts=2 sw=2 et sts=2 ai:

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<style>
h1 {
  display: inline;
}

iframe {
  width: 800px;
  height: 600px;
}

tbody {
  color: gray;
}

/* Pass styles */
tbody.pass {
  color: green;
}

li.pass {
  color: green;
}


/* Pass styles */
tbody.no-tests {
  color: yellow;
}

/* Fail styles */
tbody.fail {
  color: red;
}

li.fail {
  color: red;
}

</style>
<script src="testcases.js"></script>

<h1 id=status>Pending</h1>
Yet to start: <span id=unstarted></span>, Running: <span id=running></span>, Finished: <span id=finished></span> (Pending XHR requests: <span id=xhr></span>)

<table id="results"></table>

<script>

(function() {
window.finished = false;

/**
 * Get the most accurate version of time possible.
 *
 * @return {number} Time as this very moment.
 */
function now() {
  if (window.performance && window.performance.now) return window.performance.now();
  return Date.now();
}

var pendingXhr = [];  /* List of pending XmlHttpRequest. */

/**
 * Posts the resultObject to the serving HTTP server.
 *
 * @param {Array.<Object>} resultObject List of test-harness 
 */
function postResultsToServer(resultObject) {
  var data = new FormData();
  data.append("data", JSON.stringify(resultObject));

  var xhr = new XMLHttpRequest();
  var i = pendingXhr.push(xhr);
  xhr.onload = function () {
    var i = pendingXhr.indexOf(xhr);
    pendingXhr.splice(i, 1);
  };
  xhr.open("POST", "test-results-post.html", true);
  xhr.send(data);
}

/**
 * Creates HTML elements in a table for a test.
 *
 * +-----------+------+-------+
 * | Test Name | Link | Count |
 * +-----------+------+-------+
 * | Log of test run.         |
 * +--------------------------+
 * | iFrame containing test   |
 * +--------------------------+
 *
 * @param {String} testName Name of the test suite being run.
 * @param {String} testURL The url of the test suite.
 * @return {Element} tbody containing newly created table rows.
 */
function createTestRows(testName, testURL) {
  var tablegroup = document.createElement("tbody");
  tablegroup.id = testName;

  var basicInfoRow = document.createElement("tr");
  tablegroup.appendChild(basicInfoRow);
  var logRow = document.createElement("tr");
  tablegroup.appendChild(logRow);
  var iframeRow = document.createElement("tr");
  tablegroup.appendChild(iframeRow);

  // Name
  var header = document.createElement("h1");
  header.textContent = testName;

  var headerCell = document.createElement("td");
  headerCell.appendChild(header);
  basicInfoRow.appendChild(headerCell);

  // Link
  var link = document.createElement("a");
  link.textContent = testName;
  link.href = testURL;

  var linkCell = document.createElement("td");
  linkCell.appendChild(link);
  basicInfoRow.appendChild(linkCell);

  // Test count;
  var countCell = document.createElement("td");
  countCell.className = "count";
  basicInfoRow.appendChild(countCell);

  // table row containing the complete test log
  var logCell = document.createElement("td");
  logCell.className = "log";
  logCell.colSpan = "3";
  logRow.appendChild(logCell);

  // iframe containing a preview of object
  var iframe = document.createElement("iframe");
  iframe.src = testURL;

  var iframeCell = document.createElement("td");
  iframeCell.colSpan = "3";
  iframeCell.appendChild(iframe);
  iframeRow.appendChild(iframeCell);

  basicInfoRow.onclick = function() {
    if (logRow.style.display == "none") {
      logRow.style.display = "table-row";
      iframeRow.style.display = "table-row";
    } else {
      logRow.style.display = "none";
      iframeRow.style.display = "none";
    }
  };
  basicInfoRow.click();
  return tablegroup;
}

/**
 * Make a pretty version of a test suites results.
 *
 * @param {Array.<Object>} results
 * @return {Element} Unorder list created human readable version of the results
 *    information.
 */
function prettyResults(results) {
  var newResultsDiv = document.createElement('ul');
  for (var x in results){
    var output = document.createElement('li');
    output.innerHTML += results[x].name + " ";

    var grade = 'fail';
    if (results[x].status == 0) {
      grade = "pass";
    }
    output.className = grade;

    output.innerHTML += grade + " ";
    if (results[x].message != null) {
      output.innerHTML += results[x].message;
    }
    newResultsDiv.appendChild(output);
  }
  return newResultsDiv;
}


var runningTests = [];  /* List of test runners */
var finishedRunners = []; /* List of test runners which have completed */

var intervalId = null;
var maxParallel = 1000;

var statusElement = document.querySelector("#status")
var runningElement = document.querySelector("#running")
var finishedElement = document.querySelector("#finished")
var unstartedElement = document.querySelector("#unstarted")
var xhrElement = document.querySelector("#xhr")

/**
 * Create the test runners for each test suite listed in tests.
 */
window.onload = function createTestRunners() {
  if (runningTests.length > 0) {
    checkForResults();
  }

  for (var i = finishedRunners.length + runningTests.length;
       i < tests.length && i < (finishedRunners.length + maxParallel);
       i++) {
    var testName = tests[i];
    var testURL = "testcases/" + testName;

    console.log("Loading", testName);
    var runner = createTestRows(testName, testURL);
    runner.querySelector("iframe").onload = createTestRunners;
    runningTests.push(runner);

    document.querySelector("#results").appendChild(runner);
  }

  runningElement.innerText = runningTests.length;
  finishedElement.innerText = finishedRunners.length;
  unstartedElement.innerText = tests.length - (finishedRunners.length + runningTests.length);
  xhrElement.innerText = pendingXhr.length;

  if (runningTests.length > 0 && !intervalId) {
    statusElement.innerText = "Started";

    intervalId = window.setInterval(createTestRunners, 100);
  } else if (tests.length == finishedRunners.length && pendingXhr.length == 0) {
    statusElement.innerText = "Finished!";

    window.clearInterval(intervalId);
    window.finished = true;
  } else {
    statusElement.innerText = "Running";
  }
};

/**
 * Check to see if any of the test suites have completed and if the complete
 * test run has completed.
 */
function checkForResults() {
  for (var i = 0; i < runningTests.length; i++) {
    var runner = runningTests[i];

    var testWindow = runner.querySelector("iframe").contentWindow;
    if (testWindow.animTestRunner && testWindow.animTestRunner.results) {
      // Remove the running test
      var i = runningTests.indexOf(runner);
      runningTests.splice(i, 1);
      i--;

      finishedRunners.push(runner);
      console.log("Finished", runner.id);

      var results = testWindow.animTestRunner.results;
      if (results.length > 0) {
        var testResult = {};
        testResult["type"] = "result";
        testResult["testName"] = runner.id;
        testResult["results"] = results;
        postResultsToServer(testResult);

        var passed = results.filter(function(result) {
            return result.status == 0;
          }).length;
        var failed = results.length - passed;

        if (!failed) {
          runner.className = "pass";
        } else {
          runner.className = "fail";
        }

        var count = runner.querySelector(".count");
        count.innerHTML = passed + " of " + results.length + " passed";

        var log = runner.querySelector(".log");
        log.appendChild(prettyResults(results));
      } else {
        runner.className = "no-tests";
      }

      testWindow.animTestRunner.results = null;
    }
  }

}


})();
</script>
