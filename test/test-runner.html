<!--
Copyright 2012 Google Inc. All Rights Reserved.

vim: set ts=2 sw=2 et sts=2 ai:

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<style>
iframe {
  width: 800px;
  height: 600px;
}

tbody {
  color: gray;
}

tbody h1 {
  display: inline;
}

/* Pass styles */
tbody.pass {
  color: green;
}

li.pass {
  color: green;
}


/* Pass styles */
tbody.no-tests {
  color: yellow;
}

/* Fail styles */
tbody.fail {
  color: red;
}

li.fail {
  color: red;
}

</style>
<script src="testcases.js"></script>
<table id="results"></table>

<script>

(function() {
window.finished = false;

/**
 * Get the most accurate version of time possible.
 *
 * @return {number} Time as this very moment.
 */
function now() {
  if (window.performance && window.performance.now) return window.performance.now();
  return Date.now();
}

var pendingXhr = [];  /* List of pending XmlHttpRequest. */

/**
 * Posts the resultObject to the serving HTTP server.
 *
 * @param {Array.<Object>} resultObject List of test-harness 
 */
function postResultsToServer(resultObject) {
  var data = new FormData();
  data.append("data", JSON.stringify(resultObject));

  var xhr = new XMLHttpRequest();
  var i = pendingXhr.push(xhr);
  xhr.onload = function () {
    for (var i = 0; i < pendingXhr.length; i++) {
      if (xhr === pendingXhr[i]) {
        pendingXhr.shift(i);
      }
    }
  };
  xhr.open("POST", "test-results-post.html", true);
  xhr.send(data);
}

/**
 * Creates HTML elements in a table for a test.
 *
 * @param {String} testName Name of the test suite being run.
 * @param {String} testURL The url of the test suite.
 * @return {Element} tbody containing newly created table rows.
 */
function createTestRows(testName, testURL) {
  var tablegroup = document.createElement("tbody");

  var tr1 = document.createElement("tr");
  tablegroup.appendChild(tr1);
  var tr2 = document.createElement("tr");
  tablegroup.appendChild(tr2);
  var tr3 = document.createElement("tr");
  tablegroup.appendChild(tr3);

  // Name
  var header = document.createElement("h1");
  header.appendChild(document.createTextNode(testName));

  var td1 = document.createElement("td");
  td1.appendChild(header);
  tr1.appendChild(td1);

  // Link
  var link = document.createElement("a");
  link.textContent = testName;
  link.href = testURL;

  var td2 = document.createElement("td");
  td2.appendChild(link);
  tr1.appendChild(td2);

  // Test count;
  var td3 = document.createElement("td");
  td3.className = "count";
  tr1.appendChild(td3);

  // table row containing the complete test log
  var td4 = document.createElement("td");
  td4.className = "log";
  td4.colSpan = "3";
  tr2.appendChild(td4);

  // iframe containing a preview of object
  var iframe = document.createElement("iframe");
  iframe.src = testURL;

  var td5 = document.createElement("td");
  td5.colSpan = "3";
  td5.appendChild(iframe);
  tr3.appendChild(td5);

  tr1.onclick = function() {
    if (tr2.style.display == "none") {
      tr2.style.display = "table-row";
      tr3.style.display = "table-row";
    } else {
      tr2.style.display = "none";
      tr3.style.display = "none";
    }
  };
  tr1.onclick();  // Hide this detail by default

  return tablegroup;
}

/**
 * Make a pretty version of a test suites results.
 *
 * @param {Array.<Object>} results
 * @return {Element} Unorder list created human readable version of the results
 *    information.
 */
function prettyResults(results) {
  var newResultsDiv = document.createElement('ul');
  for (var x in results){
    var output = document.createElement('li');
    output.innerHTML += results[x].name + " ";

    var grade = 'fail';
    if (results[x].status == 0) {
      grade = "pass";
    }
    output.className = grade;

    output.innerHTML += grade + " ";
    if (results[x].message != null) {
      output.innerHTML += results[x].message;
    }
    output.innerHTML += "<br>";

    newResultsDiv.appendChild(output);
  }
  return newResultsDiv;
}


var testRunners = [];  /* List of test runners */
var finishedRunners = []; /* List of test runners which have completed */

/**
 * Create the test runners for each test suite listed in tests.
 */
window.onload = function createTestRunners() {
  for (var i = 0; i < tests.length; i++) {
    var testName = tests[i];
    var testURL = "testcases/" + testName;
    testRunners.push(createTestRows(testName, testURL));
    document.querySelector("#results").appendChild(testRunners[i]);
  }
};

/**
 * Check to see if any of the test suites have completed and if the complete
 * test run has completed.
 */
function checkForResults() {
  for (var i = 0; i < testRunners.length; i++) {
    var runner = testRunners[i];

    var testWindow = runner.querySelector("iframe").contentWindow;
    if (testWindow.animTestRunner && testWindow.animTestRunner.results) {
      finishedRunners.push(tests[i]);
      console.log("Finished", tests[i]);

      var results = testWindow.animTestRunner.results;
      if (results.length > 0) {
        var testResult = {};
        testResult["type"] = "result";
        testResult["testName"] = tests[i];
        testResult["results"] = results;
        postResultsToServer(testResult);

        var passed = results.filter(function(result) {
            return result.status == 0;
          }).length;
        var failed = results.length - passed;

        if (!failed) {
          runner.className = "pass";
        } else {
          runner.className = "fail";
        }

        var count = runner.querySelector(".count");
        count.innerHTML = passed + " of " + results.length + " passed";

        var log = runner.querySelector(".log");
        log.appendChild(prettyResults(results));
      } else {
        runner.className = "no-tests";
      }

      testWindow.animTestRunner.results = null;
    }
  }

  console.log(testRunners.length, finishedRunners.length, pendingXhr.length);
  if (testRunners.length == finishedRunners.length && pendingXhr.length == 0) {
    console.log("Everything finished!");
    window.finished = true;
    window.clearInterval(intervalId);
  }
}

var intervalId = window.setInterval(checkForResults, 100);


})();
</script>
